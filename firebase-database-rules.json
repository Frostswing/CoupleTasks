{
    "rules": {
        // Default: deny all access
        ".read": false,
        ".write": false,
        // User data - users can read/write their own data and their partner's data
        "users": {
            "$userId": {
                // Read: own data OR if user is sharing with this userId
                ".read": "auth != null && (auth.uid == $userId || root.child('users').child(auth.uid).child('profile').child('sharing_with').val() == $userId)",
                // Write: only own data
                ".write": "auth != null && auth.uid == $userId",
                "profile": {
                    // Allow creating profile on first login
                    ".write": "auth != null && auth.uid == $userId && (!data.exists() || data.child('email').val() == newData.child('email').val())",
                    // Validation rules
                    ".validate": "newData.hasChildren(['email', 'full_name'])",
                    "email": {
                        ".validate": "newData.isString() && newData.val().matches(/^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$/)"
                    },
                    "full_name": {
                        ".validate": "newData.isString() && newData.val().length > 0 && newData.val().length <= 100"
                    },
                    "partner_email": {
                        ".validate": "newData.val() == null || (newData.isString() && newData.val().matches(/^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$/))"
                    },
                    "language_preference": {
                        ".validate": "newData.val() == null || (newData.isString() && (newData.val() == 'he' || newData.val() == 'en'))"
                    },
                    "shared_space_id": {
                        ".validate": "newData.val() == null || newData.isString()"
                    },
                    "sharing_with": {
                        ".validate": "newData.val() == null || newData.isString()"
                    },
                    "$other": {
                        ".validate": true
                    }
                },
                "tasks": {
                    "$taskId": {
                        ".write": "auth != null && auth.uid == $userId",
                        ".validate": "newData.hasChildren(['title', 'status', 'created_by'])",
                        "title": {
                            ".validate": "newData.isString() && newData.val().length > 0 && newData.val().length <= 200"
                        },
                        "description": {
                            ".validate": "newData.val() == null || (newData.isString() && newData.val().length <= 1000)"
                        },
                        "status": {
                            ".validate": "newData.isString() && (newData.val() == 'pending' || newData.val() == 'in_progress' || newData.val() == 'completed')"
                        },
                        "priority": {
                            ".validate": "newData.val() == null || (newData.isString() && (newData.val() == 'low' || newData.val() == 'medium' || newData.val() == 'high'))"
                        },
                        "category": {
                            ".validate": "newData.val() == null || newData.isString()"
                        },
                        "assigned_to": {
                            ".validate": "newData.val() == null || (newData.isString() && newData.val().matches(/^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$/))"
                        },
                        "created_by": {
                            ".validate": "newData.isString() && (newData.val() == auth.uid || newData.val() == $userId)"
                        },
                        "created_date": {
                            ".validate": "newData.val() == null || newData.isString()"
                        },
                        "updated_date": {
                            ".validate": "newData.val() == null || newData.isString()"
                        },
                        "is_archived": {
                            ".validate": "newData.val() == null || newData.isBoolean()"
                        },
                        "$other": {
                            ".validate": true
                        }
                    }
                },
                "shopping_list_items": {
                    "$itemId": {
                        ".write": "auth != null && auth.uid == $userId",
                        ".validate": "newData.hasChildren(['name', 'category'])",
                        "name": {
                            ".validate": "newData.isString() && newData.val().length > 0 && newData.val().length <= 100"
                        },
                        "category": {
                            ".validate": "newData.isString()"
                        },
                        "quantity": {
                            ".validate": "newData.val() == null || (newData.isNumber() && newData.val() >= 0)"
                        },
                        "unit": {
                            ".validate": "newData.val() == null || newData.isString()"
                        },
                        "is_purchased": {
                            ".validate": "newData.val() == null || newData.isBoolean()"
                        },
                        "is_archived": {
                            ".validate": "newData.val() == null || newData.isBoolean()"
                        },
                        "$other": {
                            ".validate": true
                        }
                    }
                },
                "inventory_items": {
                    "$itemId": {
                        ".write": "auth != null && auth.uid == $userId",
                        ".validate": "newData.hasChildren(['name', 'category'])",
                        "name": {
                            ".validate": "newData.isString() && newData.val().length > 0 && newData.val().length <= 100"
                        },
                        "category": {
                            ".validate": "newData.isString()"
                        },
                        "current_amount": {
                            ".validate": "newData.val() == null || (newData.isNumber() && newData.val() >= 0)"
                        },
                        "minimum_amount": {
                            ".validate": "newData.val() == null || (newData.isNumber() && newData.val() >= 0)"
                        },
                        "unit": {
                            ".validate": "newData.val() == null || newData.isString()"
                        },
                        "$other": {
                            ".validate": true
                        }
                    }
                },
                "history": {
                    ".write": "auth != null && auth.uid == $userId",
                    "$other": {
                        ".validate": true
                    }
                }
            }
        },
        // Shared spaces - accessible by both members
        "shared": {
            "$sharedSpaceId": {
                // Read: must be a member
                ".read": "auth != null && root.child('shared').child($sharedSpaceId).child('members').child(auth.uid).exists()",
                // Write: must be a member
                ".write": "auth != null && root.child('shared').child($sharedSpaceId).child('members').child(auth.uid).exists()",
                "members": {
                    ".read": "auth != null && root.child('shared').child($sharedSpaceId).child('members').child(auth.uid).exists()",
                    // Allow members to add themselves (for initial creation)
                    ".write": "auth != null && (root.child('shared').child($sharedSpaceId).child('members').child(auth.uid).exists() || !data.exists())",
                    "$memberId": {
                        ".validate": "newData.isBoolean() && newData.val() == true"
                    }
                },
                "created_at": {
                    ".validate": "newData.isString()"
                },
                "updated_at": {
                    ".validate": "newData.isString()"
                },
                "tasks": {
                    "$taskId": {
                        ".validate": "newData.hasChildren(['title', 'status', 'created_by'])",
                        "title": {
                            ".validate": "newData.isString() && newData.val().length > 0 && newData.val().length <= 200"
                        },
                        "description": {
                            ".validate": "newData.val() == null || (newData.isString() && newData.val().length <= 1000)"
                        },
                        "status": {
                            ".validate": "newData.isString() && (newData.val() == 'pending' || newData.val() == 'in_progress' || newData.val() == 'completed')"
                        },
                        "priority": {
                            ".validate": "newData.val() == null || (newData.isString() && (newData.val() == 'low' || newData.val() == 'medium' || newData.val() == 'high'))"
                        },
                        "category": {
                            ".validate": "newData.val() == null || newData.isString()"
                        },
                        "assigned_to": {
                            ".validate": "newData.val() == null || (newData.isString() && newData.val().matches(/^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$/))"
                        },
                        "created_by": {
                            ".validate": "newData.isString() && root.child('shared').child($sharedSpaceId).child('members').child(newData.val()).exists()"
                        },
                        "$other": {
                            ".validate": true
                        }
                    }
                },
                "shopping_list_items": {
                    "$itemId": {
                        ".validate": "newData.hasChildren(['name', 'category'])",
                        "name": {
                            ".validate": "newData.isString() && newData.val().length > 0 && newData.val().length <= 100"
                        },
                        "category": {
                            ".validate": "newData.isString()"
                        },
                        "quantity": {
                            ".validate": "newData.val() == null || (newData.isNumber() && newData.val() >= 0)"
                        },
                        "unit": {
                            ".validate": "newData.val() == null || newData.isString()"
                        },
                        "$other": {
                            ".validate": true
                        }
                    }
                },
                "inventory_items": {
                    "$itemId": {
                        ".validate": "newData.hasChildren(['name', 'category'])",
                        "name": {
                            ".validate": "newData.isString() && newData.val().length > 0 && newData.val().length <= 100"
                        },
                        "category": {
                            ".validate": "newData.isString()"
                        },
                        "current_amount": {
                            ".validate": "newData.val() == null || (newData.isNumber() && newData.val() >= 0)"
                        },
                        "minimum_amount": {
                            ".validate": "newData.val() == null || (newData.isNumber() && newData.val() >= 0)"
                        },
                        "unit": {
                            ".validate": "newData.val() == null || newData.isString()"
                        },
                        "$other": {
                            ".validate": true
                        }
                    }
                },
                "shopping_sessions": {
                    "$sessionId": {
                        ".validate": "newData.hasChildren(['started_by', 'started_at'])",
                        "started_by": {
                            ".validate": "newData.isString() && root.child('shared').child($sharedSpaceId).child('members').child(newData.val()).exists()"
                        },
                        "$other": {
                            ".validate": true
                        }
                    }
                },
                "history": {
                    "$other": {
                        ".validate": true
                    }
                },
                "$other": {
                    ".validate": true
                }
            }
        },
        // App metadata - readable by all authenticated users, writable only for initialization
        "app_metadata": {
            // Read: any authenticated user
            ".read": "auth != null",
            // Write: allow initialization if database_version doesn't exist yet
            ".write": "auth != null && !root.child('app_metadata').child('database_version').exists()",
            "database_version": {
                ".read": "auth != null",
                // Allow writing version if it doesn't exist (initialization)
                ".write": "auth != null && !data.exists()",
                ".validate": "newData.isString()"
            },
            "categories": {
                ".read": "auth != null",
                // Allow writing categories if database_version doesn't exist (initialization)
                ".write": "auth != null && !root.child('app_metadata').child('database_version').exists()",
                "$categoryId": {
                    ".validate": "newData.hasChildren(['id', 'name_he', 'name_en'])"
                }
            },
            "units": {
                ".read": "auth != null",
                // Allow writing units if database_version doesn't exist (initialization)
                ".write": "auth != null && !root.child('app_metadata').child('database_version').exists()",
                "$unitId": {
                    ".validate": "newData.hasChildren(['id', 'name_he', 'name_en'])"
                }
            },
            "last_migration": {
                ".read": "auth != null",
                // Allow writing migration timestamp during initialization
                ".write": "auth != null && !root.child('app_metadata').child('database_version').exists()",
                ".validate": "newData.isString()"
            }
        },
        // Analytics - read/write disabled for now (can be enabled later)
        "analytics": {
            ".read": false,
            ".write": false
        }
    }
}