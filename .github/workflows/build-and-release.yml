name: Build and Release

on:
  push:
    tags:
      - 'v*.*.*'  # Trigger on version tags like v1.0.0

jobs:
  build-android:
    name: Build Android APK
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install EAS CLI
        run: npm install -g eas-cli@latest

      - name: Setup EAS
        run: |
          # Verify EAS CLI is available
          eas --version
          
          # Check if eas.json exists, if not initialize project
          if [ ! -f "eas.json" ]; then
            echo "Initializing EAS project..."
            APP_SLUG=$(node -p "require('./app.json').expo.slug || 'coupletasks'")
            eas init --id "$APP_SLUG" --non-interactive
          fi
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

      - name: Build APK with EAS
        id: build
        run: |
          echo "Starting EAS build..."
          # EAS will automatically use remote credentials stored on Expo servers
          # If credentials don't exist, the build will fail with instructions
          eas build --platform android --profile production --non-interactive --wait
          echo "Build completed!"
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

      - name: Download APK
        run: |
          # Get the most recent build
          BUILD_JSON=$(eas build:list --platform android --limit 1 --json)
          BUILD_ID=$(echo "$BUILD_JSON" | jq -r '.[0].id')
          DOWNLOAD_URL=$(echo "$BUILD_JSON" | jq -r '.[0].artifacts.buildUrl')
          
          echo "Build ID: $BUILD_ID"
          echo "Downloading APK from: $DOWNLOAD_URL"
          
          if [ "$DOWNLOAD_URL" != "null" ] && [ -n "$DOWNLOAD_URL" ]; then
            wget -O app-release.apk "$DOWNLOAD_URL" || curl -L -o app-release.apk "$DOWNLOAD_URL"
            if [ -f app-release.apk ]; then
              echo "APK downloaded successfully"
              ls -lh app-release.apk
            else
              echo "Error: APK download failed"
              exit 1
            fi
          else
            echo "Error: Could not get download URL"
            echo "Build JSON: $BUILD_JSON"
            exit 1
          fi

      - name: Extract version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Generate release notes
        id: release_notes
        run: |
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          if [ -z "$PREVIOUS_TAG" ]; then
            COMMITS=$(git log --pretty=format:"- %s (%h)" --no-merges)
          else
            COMMITS=$(git log ${PREVIOUS_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges)
          fi
          
          NOTES="## Changes in v${{ steps.version.outputs.version }}
          
          $COMMITS
          
          ---
          *Built with EAS Build*"
          
          echo "notes<<EOF" >> $GITHUB_OUTPUT
          echo "$NOTES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: app-release.apk
          name: Release v${{ steps.version.outputs.version }}
          body: ${{ steps.release_notes.outputs.notes }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

